/*! Copyright Â© 2015-2021 Alexey Vaskovsky. Released under the MIT license */
const VTL=new class{constructor(){window.fetch||this.error("Unsupported","Fetch API",navigator.userAgent),window.XMLSerializer||this.error("Unsupported","XMLSerializer",navigator.userAgent),window.DOMParser||this.error("Unsupported","DOMParser",navigator.userAgent),window.FileReader||this.error("Unsupported","FileReader",navigator.userAgent),this._parser=new DOMParser,this._serializer=new XMLSerializer,this._reader=new FileReader,this.defaults={},this.serverAPI="*.php",this.server="";const e=document.getElementById("server");e&&(this.server=e.getAttribute("href"),this.server&&!/\/$/.test(this.server)&&(this.server+="/")),this.isLocal="file:"==location.protocol&&""==this.server,this.queryString=location.hash?location.hash.substring(1):"",this.ready(this.updateQueryString),console.log("server:",this.server||location.origin),console.log("query:",this.queryString)}ready(e){var t="loading"!==document.readyState;return e&&(window.addEventListener("hashchange",e),t?e(null):window.addEventListener("DOMContentLoaded",e)),t}updateQueryString(){VTL.queryString=location.hash?location.hash.substring(1):"";for(const e of document.querySelectorAll("#if-no-query-string, .if-no-query-string"))e.style.display=VTL.queryString?"none":"block"}setDefaults(e,t){this.defaults[e]=t}fetch(e,n){return new Promise(t=>{const r=this.server+this.serverAPI.replace("*",e)+"?"+this.queryString;window.fetch(r,n).then(e=>{ok?t(e):(e=e.statusText||e.status,VTL.error("HTTP",e,r))}).catch(e=>{VTL.error("fetch",e.message,r)})})}async get(t){if(this.isLocal){console.log("get",t,"(local)");let e=document.getElementById(t+"_data#"+this.queryString);if(e=e||document.getElementById(t+"_data"),!e)throw new Error("no "+t+"_data @"+location.pathname);return e.innerHTML}{console.log("get",t);const e=await this.fetch(t);return e.text()}}async getJSON(e){return JSON.parse(await this.get(e))}async getXML(e){return this.parseXML(await this.get(e))}async post(e,t){if(console.log("post",e,t),this.isLocal)return null;const r=await this.fetch(e,{method:"POST",cache:"no-cache",body:t});return r.text()}createView(a,e){return e&&this.setDefaults(a,e),new Promise(async t=>{const r=document.getElementById(a);if(r){this.isLocal||"FORM"!=r.tagName||r.addEventListener("submit",async e=>{e.preventDefault();e=new FormData(r),e=await VTL.post(a,e);location.href=e});const n=document.getElementById(a+"_fileinput");n&&n.addEventListener("input",async e=>{console.log("get:",a,"(file)"),e.preventDefault();e=await VTL.readFile(n);e&&(e=this.parseXML(e),r.innerHTML=VTL.renderView(a,e),VTL.updateDataList(e),t(r))}),this.ready(async()=>{var e=await VTL.getXML(a);r.innerHTML=VTL.renderView(a,e),VTL.updateDataList(e),t(r)})}})}updateView(n){return new Promise(async e=>{const t=document.getElementById(n);var r;t&&(r=await VTL.getXML(n),t.innerHTML=VTL.renderView(n,r),VTL.updateDataList(r),e(t))})}renderView(e,t){let r="";for(const n of t.getElementsByTagName(e))r+=VTL.renderElement(n);return r}updateDataList(e){for(const r of e.getElementsByTagName("datalist")){var t=r.getAttribute("id");if(t){const n=document.getElementById(t);n?n.innerHTML=this.stringifyInnerXML(r):document.getElementsByTagName("body")[0].insertAdjacentHTML("beforeEnd",this.stringifyXML(r))}}}renderElement(e){var t=document.getElementById(e.tagName+"_view");if(!t)return this.stringifyInnerXML(e);const r={};if(r.content=this.stringifyInnerXML(e),this.defaults[e.tagName])for(const a in this.defaults[e.tagName])r[a]=this.defaults[e.tagName][a];for(const i of e.parentElement.attributes)r[i.name]=i.value;for(const s of e.attributes)r[s.name]=s.value;for(const o of e.children)r[o.tagName]?r[o.tagName]+=this.renderElement(o):r[o.tagName]=this.renderElement(o);let n=t.innerHTML;return n=n.replace(/\$([A-Za-z0-9_\-]+)/g,(e,t)=>void 0!==r[t]?r[t]:"$"+t),n=n.replace(VTL.FALSE_HTML_ATTRIBUTES,""),n}readFile(e){return new Promise((t,r)=>{try{this._reader.onload=e=>{t(e.target.result)},this._reader.readAsText(e.files[0],"UTF-8")}catch(e){r(e)}})}parseXML(e){return this._parser.parseFromString(e,"application/xml")}stringifyXML(e){return this._serializer.serializeToString(e)}stringifyInnerXML(e){let t="";for(const r of e.childNodes)t+=this.stringifyXML(r);return t}error(e,t,r){console.error(`${e}: ${t}\n@${r}`)}};VTL.FALSE_HTML_ATTRIBUTES=new RegExp("("+["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected","truespeed"].join("|")+')="(false|no|off|0)?"',"gi"),document.addEventListener("DOMContentLoaded",e=>{var t;for(t of document.querySelectorAll("#btn-reload, .btn-reload"))t.addEventListener("click",e=>{e.preventDefault(),location.reload()})}),document.addEventListener("DOMContentLoaded",e=>{var t;for(t of document.querySelectorAll("#btn-print, .btn-print"))t.addEventListener("click",e=>{e.preventDefault(),window.print()})}),document.addEventListener("DOMContentLoaded",e=>{var t;for(t of document.querySelectorAll("#btn-back, .btn-back"))t.addEventListener("click",e=>{e.preventDefault(),history.back()})});
