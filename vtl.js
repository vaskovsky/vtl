/*! Copyright Â© 2015-2021 Alexey Vaskovsky. Released under the MIT license */
const VTL=new class{constructor(){window.fetch||this.error("Unsupported","Fetch API",navigator.userAgent),window.XMLSerializer||this.error("Unsupported","XMLSerializer",navigator.userAgent),window.DOMParser||this.error("Unsupported","DOMParser",navigator.userAgent),window.FileReader||this.error("Unsupported","FileReader",navigator.userAgent),this._parser=new DOMParser,this._serializer=new XMLSerializer,this._reader=new FileReader,this.isLocal="file:"==location.protocol,this.servicePrefix="",this.serviceSuffix=".php",this.defaults={},this.queryString=location.hash?location.hash.substring(1):"",this.server="";const e=document.getElementById("server");e&&(this.server=e.getAttribute("href"),this.server&&!/\/$/.test(this.server)&&(this.server+="/")),this.queryString&&window.addEventListener("DOMContentLoaded",e=>{for(const t of document.querySelectorAll("#if-no-query-string, .if-no-query-string"))t.style.display="none"}),console.log("server:",this.server||location.origin),console.log("query:",this.queryString)}setDefault(e,t){this.defaults[e]=t}getServiceURL(e){return this.server+this.servicePrefix+e+this.serviceSuffix+"?"+this.queryString}fetch(e,n){return new Promise(t=>{const r=this.getServiceURL(e);window.fetch(r,n).then(e=>{ok?t(e):(e=e.statusText||e.status,VTL.error("HTTP",e,r))}).catch(e=>{VTL.error("fetch",e.message,r)})})}async get(e){if(this.isLocal){console.log("get:",e,"(local)");var t=document.getElementById(e+"_data");if(t)return t.innerHTML;throw new Error("no "+e+"_data @"+location.pathname)}{console.log("get:",e);const r=await this.fetch(e);return r.text()}}async getJSON(e){return JSON.parse(await this.get(e))}async getXML(e){if("string"==typeof e){var t=await this.get(e);return this.parseXML(t)}if(e instanceof Element)return e;throw new Error("getXML: invalid argument: "+typeof id+": "+JSON.stringify(id))}async post(e,t){if(console.log("post:",e,t),this.isLocal)return null;const r=await this.fetch(e,{method:"POST",cache:"no-cache",body:t});return r.text()}registerService(i){return new Promise(async t=>{const r=document.getElementById(i);if(r){this.isLocal||"FORM"!=r.tagName||r.addEventListener("submit",async e=>{e.preventDefault();e=new FormData(r),e=await VTL.post(i,e);location.href=e});const n=document.getElementById(i+"_fileinput");n&&n.addEventListener("input",async e=>{console.log("get:",i,"(file)"),e.preventDefault();e=await VTL.readFile(n);e&&(e=this.parseXML(e),VTL._renderForm(r,i,e),t(r))});var e=await VTL.getXML(i);VTL._renderForm(r,i,e),t(r)}})}_renderForm(e,t,r){let n="";for(const i of r.getElementsByTagName(t))n+=VTL.renderElement(i);e.innerHTML=n;for(const s of r.getElementsByTagName("datalist"))datalistId=s.getAttribute("id"),datalistId&&(datalistOutput=document.getElementById(datalistId),datalistOutput?datalistOutput.innerHTML=this.stringifyInnerXML(s):document.getElementsByTagName("body")[0].insertAdjacentHTML("beforeEnd",this.stringifyXML(s)))}renderElement(e){var t=document.getElementById(e.tagName+"_view");if(!t)return this.stringifyInnerXML(e);const r={};if(r.content=this.stringifyInnerXML(e),this.defaults[e.tagName])for(const i in this.defaults[e.tagName])r[i]=this.defaults[e.tagName][i];for(const s of e.parentElement.attributes)r[s.name]=s.value;for(const a of e.attributes)r[a.name]=a.value;for(const o of e.children)r[o.tagName]?r[o.tagName]+=this.renderElement(o):r[o.tagName]=this.renderElement(o);let n=t.innerHTML;return n=n.replace(/\$([A-Za-z0-9_\-]+)/g,(e,t)=>void 0!==r[t]?r[t]:"$"+t),n=n.replace(VTL.FALSE_HTML_ATTRIBUTES,""),n}readFile(e){return new Promise((t,r)=>{try{this._reader.onload=e=>{t(e.target.result)},this._reader.readAsText(e.files[0],"UTF-8")}catch(e){r(e)}})}parseXML(e){return this._parser.parseFromString(e,"application/xml")}stringifyXML(e){return this._serializer.serializeToString(e)}stringifyInnerXML(e){let t="";for(const r of e.childNodes)t+=this.stringifyXML(r);return t}error(e,t,r){console.error(`${e}: ${t}\n@${r}`)}};VTL.FALSE_HTML_ATTRIBUTES=new RegExp("("+["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected","truespeed"].join("|")+')="(false|no|off|0)?"',"gi"),document.addEventListener("DOMContentLoaded",e=>{var t;for(t of document.querySelectorAll("#btn-reload, .btn-reload"))t.addEventListener("click",e=>{e.preventDefault(),location.reload()})}),document.addEventListener("DOMContentLoaded",e=>{var t;for(t of document.querySelectorAll("#btn-print, .btn-print"))t.addEventListener("click",e=>{e.preventDefault(),window.print()})}),document.addEventListener("DOMContentLoaded",e=>{var t;for(t of document.querySelectorAll("#btn-back, .btn-back"))t.addEventListener("click",e=>{e.preventDefault(),history.back()})});
